<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>Account- AgriTrade</title>
        <link rel="icon" href="{{ url_for('static', filename='AgriTrade Logo.jpeg') }}">
        <link rel="stylesheet" href="{{ url_for('static', filename='account.css') }}">
        <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600&family=Open+Sans:wght@400;700&display=swap" rel="stylesheet">
        <link rel="stylesheet" href="https://unpkg.com/boxicons@2.1.1/css/boxicons.min.css">
    </head>
    <body>
        <div class="container">
            <!-- Sidebar -->
            <nav class="sidebar" id="sidebar">
                <ul>
                    <li><a href="/dashboard"><span class="icon"><i class='bx bx-home'></i></span><span class="text"> Dashboard</span></a></li>
                    <li><a href="/manage_crops"><span class="icon"><i class='bx bx-leaf'></i></span><span class="text"> Manage Crops</span></a></li>
                    <li><a href="/inventory"><span class="icon"><i class='bx bx-list-ul'></i></span><span class="text"> Inventory</span></a></li>
                    <li><a href="/home"><span class="icon"><i class='bx bx-bar-chart'></i></span><span class="text"> Predictions</span></a></li>
                </ul>
            </nav>
        
            <!-- Main content area -->
            <div class="main-content">
                <!-- Header -->
                <header>
                    <div class="logo">
                        <img src="{{ url_for('static', filename='AgriTrade Logo.jpeg') }}" alt="AgriTrade Logo">
                        <span>AGRITRADE</span>
                    </div>
                    <nav>
                        <ul>
                            <li><a href="{{ url_for('welcome') }}" >HOME</a></li>
                            <li><a href="#">RESOURCES</a></li>
                            <li><a href="#">ABOUT US</a></li>
                            <li><a href="{{ url_for('login') }}" class="active">LOGIN</a></li>
                        </ul>
                    </nav>
                </header>
    
                <!-- User Details Section -->
                <div class="user-details" id="userDetails"> 
                    <h1>My Profile</h1>
    
                    <!-- Profile Image -->
                    <div class="details">
                        <img src="{{ url_for('static', filename='people.png') }}" alt="User Profile Image" class="profile-icon">
                        <p><strong>Full Name:</strong></p>
                        <p class="detail"><span id="fullnameDisplay">John Doe</span></p>
                        <p><strong>Email:</strong></p>
                        <p class="detail"><span id="emailDisplay">john.doe@example.com</span></p>
                        <p><strong>Phone Number:</strong></p>
                        <p class="detail"><span id="numberDisplay">07........</span></p>
                    </div>
    
                    <!-- Edit Profile Button -->
                    <button class="submit-btn" id="editProfileBtn">Edit Profile</button>
    
                    <!-- Delete Profile Section (Moved Inside) -->
                    <div class="delete-profile">
                        <a href="javascript:void(0);" id="deleteIcon">
                            <img src="{{ url_for('static', filename='delete.png') }}" alt="Delete Icon" class="delete-icon"> 
                        </a>
                        <h4 class="delete">Delete Profile</h4>
                    </div>
                </div> <!-- Closing user-details div -->
            </div> <!-- Closing main-content div -->
        </div> <!-- Closing container div -->
        
        <!-- Modal for editing profile -->
        <div id="editProfileModal" class="modal">
            <div class="modal-content">
                <span class="close-btn" id="closeModalBtn">&times;</span>
                <h1>Update Your Profile</h1>
                <form id="profileForm">
                    <div class="form-group">
                        <label for="fullname">Full Name</label>
                        <input type="text" id="fullname" name="fullname" required>
                    </div>
                    <div class="form-group">
                        <label for="email">Email</label>
                        <input type="email" id="email" name="email" required>
                    </div>
                    <div class="form-group">
                        <label for="phoneNumber">Phone Number</label>
                        <input type="text" id="phoneNumber" name="phoneNumber" required>
                    </div>
                    <div class="form-group">
                        <label for="password">Password</label>
                        <input type="password" id="password" name="password">
                    </div>
                    <div class="form-group">
                        <input type="submit" value="Update Profile">
                    </div>
                    <button type="button" class="cancel-btn" id="cancelBtn">Cancel</button>
                </form>
            </div>
        </div>
    
        <footer>
            <div class="footer-logo">
                <img src="{{ url_for('static', filename='AgriTrade Logo.jpeg') }}" alt="AgriTrade Logo">
            </div>
            <p>Â© AgriTrade. All Rights Reserved</p>
        </footer>
  
    

    


    <script type="module"> 
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, updatePassword, EmailAuthProvider, reauthenticateWithCredential, deleteUser } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js";
        
        const firebaseConfig = {
            apiKey: "AIzaSyAC0as_uoSjFWaQNEZAI_wtK1kqYAReF-0",
            authDomain: "agritrade-3fe65.firebaseapp.com",
            projectId: "agritrade-3fe65",
            storageBucket: "agritrade-3fe65.appspot.com",
            messagingSenderId: "742671449846",
            appId: "1:742671449846:web:2bd6f4b4cd0772bee6b6d7",
            measurementId: "G-5NSK9449FG"
        };
        
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        // Display user info from Firebase
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                console.log('user id', user.uid);
                try {
                    const userDocRef = doc(db, "users", user.uid);
                    const userDoc = await getDoc(userDocRef);
                    if (userDoc.exists) {
                        const userData = userDoc.data();
                        document.getElementById("fullnameDisplay").textContent = userData.fullName;
                        document.getElementById("emailDisplay").textContent = userData.email;
                        document.getElementById("numberDisplay").textContent = userData.phoneNumber;
                    } else {
                        console.log("No user data found in Firestore.");
                    }
                } catch (error) {
                    console.error("Error fetching user data from Firestore:", error);
                }
            } else {
                window.location.href = "/login";
            }
        });
        async function updateUserDetails() {
            const user = auth.currentUser;
            if (user) {
                try {
                    const userDocRef = doc(db, "users", user.uid);
                    const userDoc = await getDoc(userDocRef);
                    if (userDoc.exists()) {
                        const userData = userDoc.data();
                        document.getElementById("fullnameDisplay").textContent = userData.fullName;
                        document.getElementById("emailDisplay").textContent = userData.email;
                        document.getElementById("numberDisplay").textContent = userData.phoneNumber;
                    } else {
                        console.log("No user data found in Firestore.");
                    }
                } catch (error) {
                    console.error("Error fetching user data from Firestore:", error);
                }
            }
        }
                // Show form and hide user details when Edit Profile is clicked
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('editProfileBtn').addEventListener('click', () => {
                const modal = document.getElementById('editProfileModal');
                modal.style.display = 'block';
        
                document.getElementById('fullname').value = document.getElementById('fullnameDisplay').textContent;
                document.getElementById('email').value = document.getElementById('emailDisplay').textContent;
                document.getElementById('phoneNumber').value = document.getElementById('numberDisplay').textContent;
            });
        
            // Handle form submission
            document.getElementById('profileForm').addEventListener('submit', async (e) => {
                e.preventDefault();
        
                const fullname = document.getElementById('fullname').value;
                const email = document.getElementById('email').value;
                const phoneNumber = document.getElementById('phoneNumber').value;
                const currentPassword = prompt("Enter your current password to proceed:");
                const newPassword = document.getElementById('password').value;
        
                try {
                    const user = auth.currentUser;
        
                    if (user) {
                        // Reauthenticate the user
                        const credential = EmailAuthProvider.credential(user.email, currentPassword);
                        await reauthenticateWithCredential(user, credential);
        
                        // Update Firestore
                        await updateDoc(doc(db, "users", user.uid), {
                            fullName: fullname,
                            email: email,
                            phoneNumber: phoneNumber
                        });
        
                        // Update password if provided
                        if (newPassword) {
                            if (newPassword.length < 6) {
                                alert("Password should be at least 6 characters.");
                                return;
                            }
                            await updatePassword(user, newPassword);
                        }
        
                        alert("Profile updated successfully!");
        
                        const modal = document.getElementById('editProfileModal');
                        modal.style.display = 'none';
        
                        document.getElementById('fullnameDisplay').textContent = fullname;
                        document.getElementById('emailDisplay').textContent = email;

                        updateUserDetails();
                    }
                } catch (error) {
                    console.error("Error updating profile: ", error);
                   
                }
            });
        
            // Hide modal when Cancel button is clicked
            document.getElementById('cancelBtn').addEventListener('click', () => {
                const modal = document.getElementById('editProfileModal');
                modal.style.display = 'none';
            });
        });

        document.getElementById('deleteIcon').addEventListener('click', async () => {
            const currentPassword = prompt("Please enter your current password to confirm deletion:");

            if (currentPassword) {
                const user = auth.currentUser;

                if (!user) {
                    alert("You must be logged in to delete your account.");
                    return;
                }

                // Reauthenticate the user with their current password
                try {
                    const credential = EmailAuthProvider.credential(user.email, currentPassword);
                    await reauthenticateWithCredential(user, credential);
                    console.log("User reauthenticated successfully.");

                    // Proceed to delete the user account
                    await deleteUser(user);
                    console.log("User deleted successfully.");

                    // Show an alert and redirect if needed
                    alert("Your account has been deleted successfully.");
                    window.location.href = "/login"; // Redirect to login page after account deletion

                } catch (error) {
                    console.error("Error deleting account:", error);
                    alert("Error deleting account: " + error.message);
                }
            } else {
                alert("Password is required to delete your account.");
            }
        });
                </script>
        

</body>
</html>
